{% extends "base.html" %}
{% load static %}

{% block title %}
    {% if object %}Upravit z√°znam{% else %}Nov√Ω z√°znam{% endif %} - QuietPage
{% endblock %}

{% block content %}
<!-- Zen Mode Toggle Button (Fixed bottom-right) -->
<button type="button" class="zen-toggle" id="zen-toggle" aria-label="P≈ôepnout Zen Mode">
    <span class="zen-toggle-icon" id="zen-icon">üßò</span>
    <span class="zen-toggle-label" id="zen-label">Zen Mode</span>
</button>

<!-- Zen Mode Exit Hint -->
<div class="zen-exit-hint" id="zen-exit-hint">
    Stiskni ESC pro ukonƒçen√≠
</div>

<div class="editor-container">
    <!-- Editor Header -->
    <header class="editor-header">
        <h1 class="editor-title">
            {% if object %}
                ‚úèÔ∏è Upravit z√°znam
            {% else %}
                ‚ú® Nov√Ω z√°znam
            {% endif %}
        </h1>
        <p class="editor-subtitle text-muted">
            {% if object %}
                Naposledy upraveno {{ object.updated_at|date:"j. F Y, H:i" }}
            {% else %}
                Tv≈Øj prostor pro my≈°lenky a reflexi
            {% endif %}
        </p>
    </header>

    <!-- Entry Form -->
    <form method="post" class="entry-form" id="entry-form">
        {% csrf_token %}
        
        <!-- Title Field -->
        <div class="form-group">
            <label for="{{ form.title.id_for_label }}" class="form-label">
                Nadpis (voliteln√Ω)
            </label>
            <input 
                type="text" 
                name="{{ form.title.name }}"
                id="{{ form.title.id_for_label }}"
                class="form-input {% if form.title.errors %}is-invalid{% endif %}"
                placeholder="Sobotn√≠ r√°no, Reflexe..."
                value="{{ form.title.value|default:'' }}"
                maxlength="200"
            >
            {% if form.title.errors %}
                <div class="invalid-feedback">
                    {{ form.title.errors.0 }}
                </div>
            {% endif %}
        </div>

        <!-- Content Field (Main Textarea) -->
        <div class="form-group">
            <label for="{{ form.content.id_for_label }}" class="form-label form-label-required">
                Tv≈Øj z√°znam
            </label>
            <textarea 
                name="{{ form.content.name }}"
                id="{{ form.content.id_for_label }}"
                class="form-textarea form-textarea-journal {% if form.content.errors %}is-invalid{% endif %}"
                placeholder="Zaƒçni ps√°t..."
                required
                data-word-count="true"
                data-auto-resize="true"
            >{{ form.content.value|default:'' }}</textarea>
            {% if form.content.errors %}
                <div class="invalid-feedback">
                    {{ form.content.errors.0 }}
                </div>
            {% endif %}
        </div>

        <!-- Mood Rating Field - Custom Mood Selector -->
        <div class="form-group">
            <label class="form-label">
                Jak se dnes c√≠t√≠≈°?
            </label>
            
            <!-- Custom Mood Selector Component -->
            <div class="mood-selector" role="group" aria-label="V√Ωbƒõr n√°lady">
                <button 
                    type="button" 
                    class="mood-option {% if form.mood_rating.value == '1' %}mood-selected{% endif %}" 
                    data-mood="1"
                    aria-label="Velmi ≈°patnƒõ"
                    title="Velmi ≈°patnƒõ"
                >
                    <span class="mood-emoji">üòû</span>
                    <span class="mood-label">Velmi ≈°patnƒõ</span>
                </button>
                
                <button 
                    type="button" 
                    class="mood-option {% if form.mood_rating.value == '2' %}mood-selected{% endif %}" 
                    data-mood="2"
                    aria-label="≈†patnƒõ"
                    title="≈†patnƒõ"
                >
                    <span class="mood-emoji">üòï</span>
                    <span class="mood-label">≈†patnƒõ</span>
                </button>
                
                <button 
                    type="button" 
                    class="mood-option {% if form.mood_rating.value == '3' %}mood-selected{% endif %}" 
                    data-mood="3"
                    aria-label="Neutr√°lnƒõ"
                    title="Neutr√°lnƒõ"
                >
                    <span class="mood-emoji">üòê</span>
                    <span class="mood-label">Neutr√°lnƒõ</span>
                </button>
                
                <button 
                    type="button" 
                    class="mood-option {% if form.mood_rating.value == '4' %}mood-selected{% endif %}" 
                    data-mood="4"
                    aria-label="Dob≈ôe"
                    title="Dob≈ôe"
                >
                    <span class="mood-emoji">üôÇ</span>
                    <span class="mood-label">Dob≈ôe</span>
                </button>
                
                <button 
                    type="button" 
                    class="mood-option {% if form.mood_rating.value == '5' %}mood-selected{% endif %}" 
                    data-mood="5"
                    aria-label="Skvƒõle"
                    title="Skvƒõle"
                >
                    <span class="mood-emoji">üòä</span>
                    <span class="mood-label">Skvƒõle</span>
                </button>
            </div>
            
            <!-- Hidden input for form submission -->
            <input 
                type="hidden" 
                name="{{ form.mood_rating.name }}"
                id="{{ form.mood_rating.id_for_label }}"
                value="{{ form.mood_rating.value|default:'' }}"
            >
            
            <small class="form-help">
                Voliteln√©: Zaznamenej svou n√°ladu pro sledov√°n√≠ wellbeingu
            </small>
            {% if form.mood_rating.errors %}
                <div class="invalid-feedback">
                    {{ form.mood_rating.errors.0 }}
                </div>
            {% endif %}
        </div>

        <!-- Tags Field -->
        <div class="form-group">
            <label for="{{ form.tags.id_for_label }}" class="form-label">
                ≈†t√≠tky
            </label>
            <input 
                type="text" 
                name="{{ form.tags.name }}"
                id="{{ form.tags.id_for_label }}"
                class="form-input {% if form.tags.errors %}is-invalid{% endif %}"
                placeholder="pr√°ce, rodina, sport..."
                value="{{ form.tags.value|default:'' }}"
            >
            <small class="form-help">
                Nap≈ô√≠klad: reflexe, vdƒõƒçnost, pl√°ny
            </small>
            {% if form.tags.errors %}
                <div class="invalid-feedback">
                    {{ form.tags.errors.0 }}
                </div>
            {% endif %}
        </div>

        <!-- Form Actions -->
        <div class="form-actions">
            <button type="submit" class="btn btn-primary btn-lg">
                {% if object %}
                    üíæ Ulo≈æit zmƒõny
                {% else %}
                    ‚úÖ Vytvo≈ôit z√°znam
                {% endif %}
            </button>
            
            <a href="{% if object %}{{ object.get_absolute_url }}{% else %}{% url 'journal:entry-list' %}{% endif %}" class="btn btn-secondary btn-lg">
                ‚ùå Zru≈°it
            </a>
        </div>
    </form>

    <!-- Auto-save indicator (will be activated in √ökol 4) -->
    <div id="autosave-status" class="autosave-status" aria-live="polite" style="display: none;">
        <!-- JavaScript will populate this -->
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
/* Editor-specific styles */
.editor-container {
    max-width: 800px;
    margin: 0 auto;
    padding: var(--space-xl) var(--space-md);
}

.editor-header {
    text-align: center;
    margin-bottom: var(--space-xl);
}

.editor-title {
    font-family: var(--font-serif);
    font-size: 2rem;
    color: var(--text-main);
    margin-bottom: var(--space-xs);
}

.editor-subtitle {
    font-size: 0.875rem;
}

.entry-form {
    background-color: var(--bg-card);
    padding: var(--space-lg);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-soft);
}

/* Fix form inputs overflowing the card */
.entry-form .form-input,
.entry-form .form-textarea,
.entry-form .form-select {
    width: 100%;
    max-width: 100%;
    box-sizing: border-box;
}

.entry-form .form-group {
    width: 100%;
    max-width: 100%;
}

.form-actions {
    display: flex;
    gap: var(--space-sm);
    justify-content: center;
    margin-top: var(--space-xl);
    flex-wrap: wrap;
    max-width: 100%;
}

.form-actions .btn {
    max-width: 100%;
    box-sizing: border-box;
}

.autosave-status {
    position: fixed;
    bottom: var(--space-md);
    right: var(--space-md);
    padding: var(--space-xs) var(--space-sm);
    background-color: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-md);
    font-size: 0.875rem;
    color: var(--text-muted);
    box-shadow: var(--shadow-soft);
}

/* Mood Selector Component */
.mood-selector {
    display: flex;
    gap: var(--space-xs);
    justify-content: space-between;
    margin-bottom: var(--space-xs);
    padding: var(--space-sm);
    background-color: var(--bg-body);
    border-radius: var(--radius-md);
    max-width: 100%;
    overflow-x: auto;
}

.mood-option {
    flex: 1;
    min-width: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: var(--space-xs);
    padding: var(--space-sm);
    background-color: var(--bg-card);
    border: 2px solid var(--border-color);
    border-radius: var(--radius-md);
    cursor: pointer;
    transition: all var(--transition-base);
    font-family: var(--font-sans);
    max-width: 100%;
    box-sizing: border-box;
}

.mood-option:hover {
    border-color: var(--primary);
    transform: translateY(-2px);
    box-shadow: var(--shadow-soft);
}

.mood-option:focus {
    outline: none;
}

.mood-option:focus-visible {
    outline: 2px solid var(--primary);
    outline-offset: 2px;
}

.mood-option.mood-selected {
    border-color: var(--primary);
    background-color: var(--primary);
    color: #FFFFFF;
    transform: scale(1.05);
    box-shadow: 0 4px 12px rgba(156, 140, 116, 0.3);
}

.mood-emoji {
    font-size: 2rem;
    line-height: 1;
    display: block;
}

.mood-label {
    font-size: 0.75rem;
    font-weight: 600;
    text-align: center;
    line-height: 1.2;
    color: var(--text-main);
}

.mood-option.mood-selected .mood-label {
    color: #FFFFFF;
    font-weight: 700;
}

/* Dark mode adjustments */
@media (prefers-color-scheme: dark) {
    .mood-option.mood-selected {
        color: #1A1614;
    }
    
    .mood-option.mood-selected .mood-label {
        color: #1A1614;
    }
}

/* Responsive */
@media (max-width: 768px) {
    .editor-container {
        padding: var(--space-md) var(--space-sm);
    }
    
    .editor-title {
        font-size: 1.5rem;
    }
    
    .entry-form {
        padding: var(--space-md);
    }
    
    .form-actions {
        flex-direction: column;
    }
    
    .form-actions .btn {
        width: 100%;
    }
    /* Mood selector on mobile - hide labels, show only emojis */
    .mood-selector {
        gap: 6px;
        padding: 6px;
    }
    
    .mood-option {
        padding: 8px 4px;
        min-width: 0;
    }
    
    .mood-label {
        display: none;
    }
    
    .mood-emoji {
        font-size: 1.5rem;
    }
}

/* Extra small devices */
@media (max-width: 390px) {
    .mood-selector {
        gap: 4px;
        padding: 4px;
    }
    
    .mood-option {
        padding: 6px 2px;
        border-width: 1px;
    }
    
    .mood-emoji {
        font-size: 1.25rem;
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// Initialize entry form functionality
document.addEventListener('DOMContentLoaded', function() {
    console.log('üìù Entry form initialized');
    
    // ============================================
    // MOOD SELECTOR FUNCTIONALITY
    // ============================================
    
    const moodSelector = document.querySelector('.mood-selector');
    const moodHiddenInput = document.getElementById('{{ form.mood_rating.id_for_label }}');
    
    if (moodSelector && moodHiddenInput) {
        const moodButtons = moodSelector.querySelectorAll('.mood-option');
        
        moodButtons.forEach(button => {
            button.addEventListener('click', function() {
                const selectedMood = this.getAttribute('data-mood');
                
                // Remove selection from all buttons
                moodButtons.forEach(btn => btn.classList.remove('mood-selected'));
                
                // Add selection to clicked button
                this.classList.add('mood-selected');
                
                // Update hidden input value
                moodHiddenInput.value = selectedMood;
                
                // Visual feedback
                console.log('üòä Mood selected:', selectedMood);
                
                // Trigger auto-save
                triggerAutoSave();
            });
            
            // Keyboard support (Space/Enter)
            button.addEventListener('keydown', function(e) {
                if (e.key === ' ' || e.key === 'Enter') {
                    e.preventDefault();
                    this.click();
                }
            });
        });
        
        console.log('‚úÖ Mood selector initialized');
    }
    
    // ============================================
    // AUTO-SAVE FUNCTIONALITY
    // ============================================
    
    const titleInput = document.getElementById('{{ form.title.id_for_label }}');
    const contentTextarea = document.getElementById('{{ form.content.id_for_label }}');
    const tagsInput = document.getElementById('{{ form.tags.id_for_label }}');
    const entryForm = document.getElementById('entry-form');
    
    // Track current entry ID (null for new entries, UUID for editing)
    let currentEntryId = {% if object %}'{{ object.id }}'{% else %}null{% endif %};
    let isAutoSaving = false;
    
    // Auto-save function with AJAX
    function autoSaveEntry() {
        // Don't save if already saving or content is empty
        const content = contentTextarea.value.trim();
        if (isAutoSaving || !content) {
            return;
        }
        
        isAutoSaving = true;
        
        // Show "saving" indicator
        if (window.QuietPage && window.QuietPage.showSaveIndicator) {
            window.QuietPage.showSaveIndicator('Ukl√°d√°m...', 'saving');
        }
        
        // Prepare data
        const data = {
            title: titleInput.value.trim(),
            content: content,
            mood_rating: moodHiddenInput.value || null,
            tags: tagsInput.value.trim(),
            entry_id: currentEntryId
        };
        
        // Send AJAX request
        fetch('{% url "journal:autosave" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': window.QuietPage.getCSRFToken()
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(result => {
            isAutoSaving = false;
            
            if (result.status === 'success') {
                // Update entry ID if it's a new entry
                if (result.is_new && result.entry_id) {
                    currentEntryId = result.entry_id;
                    console.log('‚úÖ New entry created:', currentEntryId);
                    
                    // Update form action to edit mode (optional - prevents creating duplicates)
                    // This way subsequent saves will update the same entry
                    const editUrl = `/journal/${currentEntryId}/edit/`;
                    window.history.replaceState({}, '', editUrl);
                }
                
                // Show success indicator
                if (window.QuietPage && window.QuietPage.showSaveIndicator) {
                    window.QuietPage.showSaveIndicator('Automaticky ulo≈æeno', 'success');
                }
                
                console.log('üíæ Auto-save successful');
            } else {
                console.error('‚ùå Auto-save failed:', result.message);
                if (window.QuietPage && window.QuietPage.showSaveIndicator) {
                    window.QuietPage.showSaveIndicator('Chyba p≈ôi ukl√°d√°n√≠', 'error');
                }
            }
        })
        .catch(error => {
            isAutoSaving = false;
            console.error('‚ùå Auto-save error:', error);
            if (window.QuietPage && window.QuietPage.showSaveIndicator) {
                window.QuietPage.showSaveIndicator('Chyba p≈ôi ukl√°d√°n√≠', 'error');
            }
        });
    }
    
    // Debounced auto-save (1 second delay)
    const debouncedAutoSave = window.QuietPage.debounce(autoSaveEntry, 1000);
    
    // Trigger auto-save on input
    function triggerAutoSave() {
        debouncedAutoSave();
    }
    
    // Attach event listeners
    if (titleInput) {
        titleInput.addEventListener('input', triggerAutoSave);
    }
    
    if (contentTextarea) {
        contentTextarea.addEventListener('input', triggerAutoSave);
    }
    
    if (tagsInput) {
        tagsInput.addEventListener('input', triggerAutoSave);
    }
    
    console.log('‚úÖ Auto-save initialized');
    
    // ============================================
    // TEXTAREA AUTO-RESIZE (ensure it works with auto-saved content)
    // ============================================
    
    // Auto-resize is initialized globally in main.js
    // But we need to trigger it after auto-save updates content
    // This is already handled by the 'input' event listener
    
    // Trigger initial resize for pre-filled content
    if (contentTextarea && window.QuietPage && window.QuietPage.autoResizeTextarea) {
        window.QuietPage.autoResizeTextarea(contentTextarea);
    }
    
    // ============================================
    // ZEN MODE FUNCTIONALITY
    // ============================================
    
    const zenToggle = document.getElementById('zen-toggle');
    const zenIcon = document.getElementById('zen-icon');
    const zenLabel = document.getElementById('zen-label');
    let isZenMode = false;
    
    // Toggle Zen Mode
    function toggleZenMode() {
        isZenMode = !isZenMode;
        
        if (isZenMode) {
            // Activate Zen Mode
            document.body.classList.add('zen-mode-active');
            zenIcon.textContent = '‚ùå';
            zenLabel.textContent = 'Ukonƒçit';
            
            // Focus on content textarea
            if (contentTextarea) {
                contentTextarea.focus();
            }
            
            console.log('üßò Zen Mode activated');
        } else {
            // Deactivate Zen Mode
            document.body.classList.remove('zen-mode-active');
            zenIcon.textContent = 'üßò';
            zenLabel.textContent = 'Zen Mode';
            
            console.log('‚ú® Zen Mode deactivated');
        }
    }
    
    // Click handler for zen toggle button
    if (zenToggle) {
        zenToggle.addEventListener('click', function(e) {
            e.preventDefault(); // Prevent any form submission
            e.stopPropagation(); // Stop event bubbling
            toggleZenMode();
        });
    }
    
    // ESC key handler for exiting zen mode
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && isZenMode) {
            toggleZenMode();
        }
    });
    
    console.log('‚úÖ Zen Mode initialized');
});
</script>
{% endblock %}
